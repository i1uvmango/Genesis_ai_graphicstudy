# 데이터 전처리 수정 및 mlp 구조 수정


## 초기 상황
- **목표**: Genesis 시뮬레이션에서 8자(figure‑8) 트랙을 정확히 따라가게 하는 행동 복제(BC) 모델 구현.
- **스티어링이 -1.0(오른쪽)으로 포화**하고, **Throttle이 음수/진동**하는 문제를 보여 이를 해결하고자 함

## throttle 정의 
| 동작                     | v_long (전방 속도)                              | throttle_raw (물리량)          | throttle_norm (‑1 ~ 1) | 토크 방향/의미                                 |
|--------------------------|------------------------------------------------|--------------------------------|------------------------|-----------------------------------------------|
| 전진 (가속)              | v_long  >  V_LONG_EPS (양수, 충분히 빠름)      | + abs(spin_R) (양수)           | > 0 (양수)              | 양의 토크 → 차가 앞쪽으로 가속                |
| 브레이크 (감속)          | v_long  >  V_LONG_EPS (양수) **하지만** 외부에서 `throttle_norm < 0` 를 강제로 주입 | 미정의        | 미정의             | 토크 0 으로 만드는 힘 가해져 정지하도록 로직 필요|
| 토크 없이 이동 (Coasting) | abs(v_long) ≤ V_LONG_EPS (거의 정지, 속도 거의 0) | 0.0                            | 0.0                    | 토크 없음 → 관성에 따라 움직이거나 마찰·공기 저항에 의해 서서히 감속 |
| 후진 (역방향 가속)       | v_long  <  ‑V_LONG_EPS (음수, 충분히 빠름)      | ‑ abs(spin_R) (음수)           | < 0 (음수)              | 음의 토크 → 차가 뒤쪽으로 가속(후진)          |
## 주요 개선 작업 
| 단계 | 내용 | 파일 | 핵심 코드 | 비고 |
|------|------|------|-----------|------|
| **①** | **전역 위치(`g_pos`) 피처 추가** – 모델이 현재 위치를 알 수 있게 함. | `new_train.py`, `test_bc.py` | 위치정보 `g_pos_x/y/z` 추가 / `state = np.concatenate([g_pos, …])` | 8자 구분에 필수. |
| **②** | **Throttle 전처리 개선** – 음수/진동 방지. | `blender_data_extract.py` | `abs(spin_R_raw)` → `SPIN_BUFFER` 평균, `v_long` 으로 방향 결정, 정지 구역 `V_LONG_EPS` 적용. | x |
### 데이터 전처리 추가 사항
### Moving-Average Smoothing
* SPIN_BUFFER (size 5) 로 최근 회전량 평균을 사용해 급격한 변동을 완화.(throttle의 평균값을 사용하는 sliding window)
* throttle 변화를 smoothing 함
```
SPIN_BUFFER_SIZE = 5 로 정의돼 있어, 최근 5 프레임의 spin_R_raw(바퀴 회전 속도) 절댓값을 저장합니다.
새 프레임이 들어오면 가장 오래된 값이 버퍼에서 사라지고, 남은 값들의 평균을 spin_R에 할당합니다.
```
* 슬라이딩 윈도우 형태로 throttle 값을 smoothing 하는 필터 &rarr; 토크 안정화

### 클램프(clipping)
```
throttle_norm = clamp(throttle_raw / THROTTLE_OMEGA_MAX, -1.0, 1.0) 
```
### 위치정보 추가
```
g_pos_x, g_pos_y, g_pos_z, g_qw, g_qx, g_qy, g_qz, g_lin_vx, g_lin_vy, g_lin_vz, g_ang_vx, g_ang_vy, g_ang_vz, v_long, throttle_norm
```
* 위치 정보 추가해서 학습시킴 &rarr; 8자 주행에 필요한 데이터

## 📐 MLP 구조 확장

### 기존 구조
- 입력 차원: 12 (기본) → 15 (전역 위치 포함)
- 2 hidden layers, 각 128 유닛, ReLU 활성화
- 출력: `steering`, `throttle`

### 확장 내용
- **입력 차원**을 15 → 20 로 확대 (추가 피처: `g_pos`, `g_quat`, `v_long`, `spin_R` 등)
- **Hidden layers**를 3개로 증가, 각 256 유닛, `LeakyReLU` 사용
   * 미분값에 의한 노이즈가 많아서 `LeakyReLU` 사용
- **Dropout** (p=0.2) 적용하여 과적합 방지
- **출력 레이어**에 `tanh` (steering)와 `sigmoid` (throttle) 클램프 적용

### 기대 효과
- 더 복잡한 8자 궤적 패턴을 학습할 수 있는 표현력 확보
- 데이터 다양화 및 통합 학습 시 과적합 감소
- 학습 수렴 속도 향상 및 안정적인 추론 결과

## 3️⃣ 현재 코드 상태 (2025‑12‑28 기준)
- [train 코드](../src/train_bc.py) : 15‑차원 입력 (`g_pos`위치 포함) 으로 학습 준비 완료.
- [추론 및 시뮬레이션 실행](../src/test_bc.py) : `g_pos` 사용, Z‑패치 **삭제**, Throttle 전처리 최신 로직 적용.
- [데이터 추출 코드](../src/on_off_data_blender_data.py) : Spin 절댓값, 이동 평균, `v_long` 기반 Throttle 로직 적용.

### 여전히 8자 움직임 보단 원을 그리는 차량
  ![](../res/2025-12-28%20022038.gif)
## 4️⃣ 남은 과제 & 다음 단계
1. **데이터 다양화 및 양 확보**
   - 250 프레임 1세트 &rarr; 10세트 사용
   - 현재 8자 움직임의 데이터 하나만 사용 → 과적합 위험.
   - 다양한 속도·시작점·노이즈를 포함한 **다양한 데이터**(예: Auto‑Drive, 속도 변형) 를 추가.
2. **전체 데이터 재학습**
   - 현재 8자 트랙 하나만 사용 → 과적합 위험 상태.
   - 하지만 종속데이터로도 8자 움직임을 뽑아내지 못하는 상황
   - 혹시 이유가 dt에 의한 노이즈로 모델이 다른 상황으로 인지해서 움직임이 나오지 않는건가?
    * 하지만 통통 바퀴가 튀던 현상은 데이터 증가에 따라 해결됨
3. **통합 데이터 학습 후 8자 주행 추론**
   - 움직임 모든 데이터 전체 통합 후 학습 시킨 뒤
   * 8자 움직임에 대한 데이터만 추론 시켜서 모사해 볼 예정
   * 적어도 overfitting 에 의한 문제는 해결할 수 있음

## 5️⃣ 요약
- **전역 위치**와 **Throttle 전처리**를 추가·수정하여 기본적인 음수/진동 문제를 해결.
- 앞으로는 **데이터 증량**과 **통합 데이터**를 통해 8자 트랙을 정확히 따라가도록 모델을 강화할 예정.


---
*작성일: 2025‑12‑28*
