# Troubleshooting

## 실패했던 원인 분석 및 설계시 유의 사항

### 1. 학습 데이터의 "과도한 이상성" (The Perfection Trap)
* **[문제점]**
    * Blender 데이터가 물리적 노이즈 없는 '레일 주행' 상태여서 $CTE, HE \approx 0$인 데이터만 생성됨.
    * 모델은 오차 복구 방법(Recovery Logic)을 배울 기회가 없어, 실전(Genesis)에서 미세한 오차 발생 시 제어 신호가 발산함.
* **[해결책: 데이터 증강 및 노이즈 주입]**
    * **Stage 3 (State Perturbation):** 최적화 시작 시 차량 위치에 $\mathcal{N}(0, \sigma)$ 가우스 노이즈를 주어 '강제 오차 상황'에서의 정답 데이터 추출.
    * **Stage 4 (Input Jittering):** 학습 시 $CTE, HE$ 입력값에 미세한 노이즈를 섞어 모델의 유연성(Robustness) 확보.
    * **Trajectory Sampling:** Look-ahead 거리를 가변적으로 설정하여 다양한 곡률에 대응.

#### 좁은 표준편차($\sigma=0.1$)의 함정: "터널 시야"
* 학습 데이터에서 오차($CTE$)의 표준편차가 0.1 정도로 매우 작다는 것은, 모델이 경로 중심에서 $\pm 0.1m$ 이내에 있는 상황만 수만 번 경험했다는 뜻입니다.
* **학습 영역 (Safe Zone):** $CTE \in [-0.1, 0.1]$ → 모델이 "어떻게 해야 할지" 잘 아는 구간.
* **미지의 영역 (Danger Zone):** $CTE > 0.1$ 또는 $CTE < -0.1$.
    * 제네시스 시뮬레이션에서 물리적 차이로 인해 차가 아주 살짝 밀려 $CTE=0.15$가 되는 순간, 모델 입장에서는 **태어나서 처음 보는 "외계 환경"**에 처하게 됩니다.

#### 왜 발산(Explosion)으로 이어지는가?
이 현상은 보통 아래와 같은 **악순환(Positive Feedback Loop)**을 그리며 발생합니다.
1. **미세 오차 발생:** 제네시스 엔진 특성상 $CTE$가 $0.1$을 살짝 넘어감.
2. **모델의 패닉 (Out-of-Distribution):** 경험해본 적 없는 $0.1$ 이상의 입력을 받자, MLP의 활성화 함수가 비정상적으로 높은 값을 출력함.
3. **과도한 조작:** 모델이 핸들을 너무 세게 꺾거나 반대로 꺾어버림.
4. **오차 증폭:** 잘못된 조작으로 $CTE$가 $0.1$에서 $0.5, 1.0$으로 순식간에 커짐.
5. **시스템 붕괴:** 제어 불능 상태로 시뮬레이션 종료.
> 이를 전문 용어로 **'복합 오차(Compounding Error)'**라고 하며, 모사 학습(Imitation Learning)에서 경로 정보가 완벽할 때 가장 흔히 발생하는 실패 사례입니다.

#### 해결책: "실수의 범위를 넓혀라"
Troubleshooting 문서에 적으셨던 **데이터 증강(Augmentation)**이 바로 이 표준편차를 강제로 늘리는 작업입니다.
* **기존 데이터:** $CTE \sim \mathcal{N}(0, 0.01)$ (매우 좁음, 복원력 없음)
* **증강된 데이터:** $CTE \sim \mathcal{N}(0, 0.5)$ (의도적으로 0.5m까지 오차 상황을 만듦)
* 표준편차를 키워서 학습시키면, 모델은 $CTE=0.2$나 $0.3$인 상황에서도 **"아, 이 정도는 핸들을 이만큼 꺾어서 돌아가면 돼"**라는 **복원 규칙(Recovery Rule)**을 가지게 됩니다.

---

### 2. 제어 지연과 진동 현상 (Latency & Oscillation)
* **[추가 문제점]**
    * **현상:** 차가 경로를 따라가긴 하지만, 좌우로 심하게 흔들리거나(S-자 주행) 커브에서 한 박자 늦게 반응함.
    * **원인:**
        1. **시뮬레이션 스텝 차이:** Genesis의 $dt$와 조작 신호가 반영되는 타이밍의 미세한 간극.
        2. **순수 피드백의 한계:** 오차가 발생한 '후'에만 수정하려 하면 필연적으로 오버슈트(Overshoot) 발생.
* **[해결 및 설계 유의사항]**
    * **Look-ahead(예견 제어) 강화:** 현재 오차뿐만 아니라 미래 오차($la\_CTE$)를 피처로 넣어 '미리' 핸들을 꺾도록 설계.
    * **Damping 강화:** Stage 3의 목적 함수에서 $HE$(Heading Error) 페널티를 높여 방향 변화를 억제하거나, Genesis의 kv 게인을 조절하여 물리적 감쇠력을 확보.

### 아직 해결하지 못함
* 개선해 나가는 부분
* fine tuning 이 필요
---

### 3. 목적 함수 내 가중치 불균형 (Weight Imbalance)
* **[추가 문제점]**
    * **현상:** 가속도는 잘 맞는데 경로를 이탈하거나, 반대로 경로는 잘 지키는데 속도가 블렌더와 판이하게 다름.
    * **원인:** 목적 함수($\mathcal{L}$) 내의 Motion Matching 항과 Path Alignment 항 사이의 가중치($\beta$) 튜닝 실패.
* **[설계 가이드라인]**
    $$ \mathcal{L} = (a_{gen} - a^*)^2 + 5(k_{gen} - k^*)^2 + \beta_1 CTE^2 + \beta_2 HE^2 $$
    * 조향(곡률)은 가속도보다 물리적 민감도가 높으므로 통상 5배 이상의 가중치 부여.
    * **$\beta$ 튜닝 순서:** 먼저 물리 번역($a, k$)이 선행된 후, 서서히 경로 페널티($CTE$)를 올려가며 복원력을 주입해야 함.

---

### 4. Stage 1 & 2의 존재 이유 (Why not meaningless?)
* **[유의 사항]**
    * Stage 1, 2에 $CTE$가 없는 것은 설계 오류가 아닌 **'도메인 분리'** 전략임.
    * **Stage 1 & 2 (Physics Sync):** "차량 자체의 성능" 캘리브레이션. (예: 엔진 성능, 타이어 마찰)
    * **Stage 3 & 4 (Control Strategy):** "운전자의 지능" 학습. (예: 경로 유지, 위기 대처)
* **[결론]**
    * 기초 공사(1, 2)가 없으면 아무리 똑똑한 운전자(4)라도 차의 성능을 몰라 사고를 냄.

#### 그렇다면 stage1,2에 CTE , HE가 들어가지 않는데 의미 없는 stage 인가?
Stage 1과 2의 학습 데이터에 $CTE$가 없어도 되는 이유는, 이 단계들이 해결하려는 문제가 **"경로를 지키는 법"**이 아니라 **"힘의 크기를 맞추는 법"**이기 때문입니다.
* **Stage 1 (Env Sync):** "블렌더에서 가속도 $1.0$을 내려면 제네시스에서는 엔진 토크를 얼마로 설정해야 하지?"라는 정적(Static) 차이를 학습합니다.
* **Stage 2 (Residual Dynamics):** "핸들을 $0.5$ 꺾었을 때, 제네시스 타이어는 블렌더보다 얼마나 더 미끄러지지?"라는 동적(Dynamic) 오차를 학습합니다.
* 즉, Stage 1 & 2는 $CTE$가 $0$인 상태, 즉 **'완벽하게 달리고 있을 때'조차 발생하는 두 엔진 사이의 물리적 괴리($Residual$)를 메우는 기초 공사**입니다.

---

### 5. 국소 최적해 문제 (Local Minima in Stage 3)
* **[추가 문제점]**
    * **현상:** 특정 구간에서 scipy.minimize가 정답을 찾지 못하고 이상한 $T, S$ 값을 뱉음.
    * **원인:** 비선형적인 물리 엔진 특성상 목적 함수 표면이 매끄럽지 않아 최적화 도구가 길을 잃음.
* **[해결책]**
    * **Warm Start:** 이전 프레임의 정답($T, S$)을 다음 프레임의 최적화 초기값으로 사용하여 연속성 확보.
    * **Bound 제약:** 핸들각과 스로틀의 범위를 물리적 한계치(max_steer) 내로 엄격히 제한하여 탐색 범위 축소.